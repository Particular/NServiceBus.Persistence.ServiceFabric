name: CI
on:
  push:
    branches:
      - master
      - release-*
  pull_request:
  workflow_dispatch:
env:
  DOTNET_NOLOGO: true
defaults:
  run:
    shell: pwsh
jobs:
  build:
    name: Windows
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4.2.2
        with:
          fetch-depth: 0
      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4.3.1
        with:
          dotnet-version: 9.0.x
      - name: Add NuGet CLI
        uses: nuget/setup-nuget@v2.0.0
      - name: Restore sfproj packages
        run: nuget restore src/AcceptanceTestsApplication/packages.config -PackagesDirectory src/packages
      - name: Build
        run: dotnet build src --configuration Release
      - name: Upload packages
        uses: actions/upload-artifact@v4.6.2
        with:
          name: NuGet packages
          path: nugets/
          retention-days: 7
      - name: Set up local 5-node Service Fabric cluster
        shell: powershell
        run: |
          $ErrorActionPreference = 'Stop'

          Set-ExecutionPolicy -ExecutionPolicy Unrestricted -Scope CurrentUser -Force

          $setupDir = Join-Path ${env:ProgramW6432} 'Microsoft SDKs\Service Fabric\ClusterSetup'
          $devSetup = Join-Path $setupDir 'DevClusterSetup.ps1'
          $cleanPs  = Join-Path $setupDir 'CleanCluster.ps1'

          function Install-ServiceFabric {
            [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12
            $dl = Join-Path $env:TEMP 'SFInstall'
            New-Item -ItemType Directory -Force -Path $dl | Out-Null

            $runtimeUrl = 'https://download.microsoft.com/download/b/8/a/b8a2fb98-0ec1-41e5-be98-9d8b5abf7856/MicrosoftServiceFabric.11.1.208.1.exe'
            $sdkUrl     = 'https://download.microsoft.com/download/b/8/a/b8a2fb98-0ec1-41e5-be98-9d8b5abf7856/MicrosoftServiceFabricSDK.8.1.208.msi'

            $runtimeExe = Join-Path $dl (Split-Path $runtimeUrl -Leaf)
            $sdkMsi     = Join-Path $dl (Split-Path $sdkUrl -Leaf)

            Invoke-WebRequest -Uri $runtimeUrl -OutFile $runtimeExe
            Invoke-WebRequest -Uri $sdkUrl -OutFile $sdkMsi

            $p = Start-Process -FilePath $runtimeExe -ArgumentList '/accepteula /quiet /norestart' -Wait -PassThru
            if ($p.ExitCode -ne 0 -and $p.ExitCode -ne 3010) { throw "Runtime install failed: $($p.ExitCode)" }

            $p = Start-Process -FilePath 'msiexec.exe' -ArgumentList "/i `"$sdkMsi`" /quiet /norestart" -Wait -PassThru
            if ($p.ExitCode -ne 0 -and $p.ExitCode -ne 3010) { throw "SDK install failed: $($p.ExitCode)" }
          }

          if (-not (Test-Path $devSetup)) {
            Write-Host 'Service Fabric SDK not found; installing...'
            Install-ServiceFabric
          }

          # Clean any previous local cluster (no -ForceRemove)
          if (Test-Path $cleanPs) {
            try { & $cleanPs -ErrorAction Stop }
            catch {
              Write-Warning "CleanCluster.ps1 failed; attempting manual cleanup..."
              # Manual fallback
              $svc = Get-Service -Name FabricHostSvc -ErrorAction SilentlyContinue
              if ($svc) { Stop-Service FabricHostSvc -Force -ErrorAction SilentlyContinue }
              Get-Process fabric*,FabricHost -ErrorAction SilentlyContinue | Stop-Process -Force -ErrorAction SilentlyContinue
              if (Test-Path 'C:\SfDevCluster') { Remove-Item 'C:\SfDevCluster' -Recurse -Force -ErrorAction SilentlyContinue }
            }
          }

          # Create a local 5-node cluster (default)
          & $devSetup | Tee-Object -FilePath $env:TEMP\DevClusterSetup.out

          # Verify readiness via service & ports (no SF module import)
          $deadline = (Get-Date).AddMinutes(5)
          do {
            $svc = Get-Service -Name FabricHostSvc -ErrorAction SilentlyContinue
            $okSvc = $svc -and $svc.Status -eq 'Running'
            $ok19080 = (Test-NetConnection -ComputerName 'localhost' -Port 19080 -WarningAction SilentlyContinue).TcpTestSucceeded
            $ok19000 = (Test-NetConnection -ComputerName 'localhost' -Port 19000 -WarningAction SilentlyContinue).TcpTestSucceeded
            if ($okSvc -and $ok19080 -and $ok19000) { break }
            Start-Sleep -Seconds 5
          } while ((Get-Date) -lt $deadline)

          if (-not ($okSvc -and $ok19080 -and $ok19000)) {
            Write-Host '--- tail C:\SfDevCluster\Log\DevClusterSetup.log ---'
            Get-Content 'C:\SfDevCluster\Log\DevClusterSetup.log' -Tail 200 -ErrorAction SilentlyContinue
            throw 'Service Fabric cluster failed to become ready.'
          }

          Write-Host 'Service Fabric Explorer: http://localhost:19080/Explorer'
      - name: Run tests
        uses: Particular/run-tests-action@v1.7.0
